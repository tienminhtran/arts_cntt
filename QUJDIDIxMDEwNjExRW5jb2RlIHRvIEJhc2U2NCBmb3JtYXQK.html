<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thống kê danh sách</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    /* Đảm bảo bảng scroll khi cao quá */
    #dataTableContainer {
      max-height: 500px;
      overflow-y: auto;
    }
  </style>
</head>
<body class="bg-light">
<div class="container py-5">
  <h2 class="mb-4">Danh sách sinh viên</h2>

  <!-- Thanh tìm kiếm và nút -->
  <div class="mb-3 d-flex flex-wrap gap-2">
    <input type="text" id="searchInput" class="form-control" placeholder="Tìm theo MSSV hoặc họ tên" style="max-width:300px;">
    <button class="btn btn-primary" onclick="searchTable()">Tìm</button>
    <button class="btn btn-success" onclick="exportExcel()">Xuất Excel</button>
    <!-- <button class="btn btn-danger" onclick="removeDuplicatesAPI()">Xóa trùng MSSV trên API</button> -->
  </div>

  <!-- Grid bảng và biểu đồ -->
  <div class="row">
    <!-- Bảng dữ liệu bên trái -->
    <div class="col-md-7 mb-3">
      <div id="dataTableContainer" class="border bg-white p-2 rounded">
        <table class="table table-bordered table-striped mb-0" id="dataTable">
          <thead class="table-dark">
            <tr>
              <th>Họ tên</th>
              <th>SĐT</th>
              <th>Thời gian dự thi</th>
              <th>Khung giờ</th>
              <th>MSSV</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Biểu đồ bên phải -->
    <div class="col-md-5 mb-3">
      <div class="border bg-white p-3 rounded">
        <h5 class="text-center">Thống kê theo khung giờ</h5>
        <canvas id="pieChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
let dataList = [];

// Lấy dữ liệu từ API
async function fetchData() {
  try {
    const res = await fetch('https://68d3b294214be68f8c66d81b.mockapi.io/danhsach');
    dataList = await res.json();
    renderTable(dataList);
    renderChart(dataList);
  } catch(err) {
    console.error(err);
    alert('Lỗi khi tải dữ liệu!');
  }
}

// Hiển thị bảng
function renderTable(data) {
  const tbody = document.querySelector('#dataTable tbody');
  tbody.innerHTML = '';
  data.forEach(item => {
    tbody.innerHTML += `
      <tr>
        <td>${item.hoten}</td>
        <td>${item.sodienthoai}</td>
        <td>${item.thoigianduthi}</td>
        <td>${item.khunggio}</td>
        <td>${item.mssv}</td>
      </tr>
    `;
  });
}

// Tìm kiếm theo MSSV hoặc họ tên
function searchTable() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  const filtered = dataList.filter(item =>
    item.mssv.toLowerCase().includes(query) ||
    item.hoten.toLowerCase().includes(query)
  );
  renderTable(filtered);
  renderChart(filtered);
}

// Vẽ biểu đồ tròn theo khung giờ
function renderChart(data) {
  const ctx = document.getElementById('pieChart').getContext('2d');
  const khunggioCounts = {};
  data.forEach(item => {
    khunggioCounts[item.khunggio] = (khunggioCounts[item.khunggio] || 0) + 1;
  });

  const labels = Object.keys(khunggioCounts);
  const values = Object.values(khunggioCounts);

  if(window.pieChartInstance) window.pieChartInstance.destroy(); // xóa chart cũ
  window.pieChartInstance = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: labels.map(() => '#' + Math.floor(Math.random()*16777215).toString(16))
      }]
    },
    options: {
      responsive: true
    }
  });
}

// Xuất Excel
function exportExcel() {
  const wb = XLSX.utils.book_new();
  const ws_data = [
    ["Họ tên","SĐT","Thời gian dự thi","Khung giờ","MSSV"],
    ...dataList.map(item => [item.hoten, item.sodienthoai, item.thoigianduthi, item.khunggio, item.mssv])
  ];
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "DanhSach");
  XLSX.writeFile(wb, "DanhSach.xlsx");
}

async function removeDuplicatesAPI() {
  const seen = new Set();
  const duplicates = [];

  // Tìm các bản ghi trùng MSSV
  dataList.forEach(item => {
    if(seen.has(item.mssv)) {
      duplicates.push(item); // lưu bản ghi trùng để xóa
    } else {
      seen.add(item.mssv);
    }
  });

  if(duplicates.length === 0) {
    alert("Không có bản ghi trùng MSSV.");
    return;
  }

  // Xóa từng bản ghi trùng trên API
  for(const item of duplicates) {
    try {
      await fetch(`https://68d3b294214be68f8c66d81b.mockapi.io/danhsach/${item.id}`, {
        method: 'DELETE'
      });
    } catch(err) {
      console.error("Xóa thất bại MSSV:", item.mssv, err);
    }
  }

  alert(`Đã xóa ${duplicates.length} bản ghi trùng MSSV trên API.`);

  // Load lại dữ liệu từ API
  fetchData();
}


// Load dữ liệu khi mở trang
fetchData();
</script>
</body>
</html>
