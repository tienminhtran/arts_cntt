<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tra cứu CNTT</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-blue-100 via-purple-100 to-pink-100 min-h-screen flex items-center justify-center">

  <div class="bg-white shadow-2xl rounded-2xl p-8 w-full max-w-3xl">
    <h1 class="text-3xl font-bold text-center text-purple-700 mb-6">Tra cứu thông tin Văn Nghệ 2025</h1>

    <!-- Form tìm kiếm -->
    <form id="searchForm" class="flex gap-2 mb-6">
      <input id="mssvInput" type="text" placeholder="Nhập MSSV..." 
             class="flex-1 border rounded-xl p-3 focus:ring focus:ring-purple-300 shadow-sm">
      <button type="submit" class="bg-purple-600 text-white px-5 py-3 rounded-xl hover:bg-purple-700 font-semibold shadow">
        Tra cứu
      </button>
    </form>

    <!-- Kết quả -->
    <div id="result" class="space-y-4"></div>
  </div>

  <script>
    const API_URL = "https://68dd11d77cd1948060ac464f.mockapi.io/vannghe"; 
    let currentSV = null;

    // Hàm hiển thị thông tin
    function renderInfo(sv) {
      const container = document.getElementById("result");
      if (!sv) {
        container.innerHTML = `<p class="text-red-600 font-semibold text-center">Không tìm thấy MSSV.</p>`;
        return;
      }

      let infoHTML = `
        <div class="border rounded-xl p-6 bg-gray-50 shadow">
          <h2 class="text-xl font-bold mb-3 text-purple-700">Thông tin sinh viên</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            ${Object.entries(sv).map(([k,v]) => `
              <div class="p-3 border rounded-lg bg-white shadow-sm">
                <span class="font-semibold capitalize text-gray-700">${k}:</span><br>
                ${v === "" 
                  ? `<span class="text-red-500 font-semibold">Chưa có</span>` 
                  : `<span class="text-gray-900">${v}</span>`}
              </div>
            `).join("")}
          </div>
          <p class="mt-3">Trạng thái: 
            ${sv.trangthai == 1 
              ? `<span class="px-2 py-1 bg-green-100 text-green-700 rounded-lg text-sm font-medium">Đã hoàn tất</span>`
              : `<span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-lg text-sm font-medium">Chưa hoàn tất</span>`}
          </p>
        </div>
      `;

      // Nếu trạng thái = 0 thì hiển thị form cập nhật
      if (sv.trangthai == 0) {
        infoHTML += `
          <form id="updateForm" class="mt-6 space-y-4 p-6 border rounded-xl bg-white shadow">
            <h3 class="font-semibold text-purple-700 text-lg mb-3">Cập nhật thông tin còn thiếu</h3>
            ${Object.keys(sv).filter(k => !["id","mssv","trangthai"].includes(k)).map(key => {
              // ✅ Nếu khunggio rỗng -> disable không cho nhập
              if (key === "khunggio" && !sv[key]) {
                return `
                  <div>
                    <label class="block text-sm font-medium capitalize text-gray-600">${key}</label>
                    <input name="${key}" value="" 
                           readonly disabled
                           class="w-full border p-3 rounded-lg bg-gray-200 text-gray-400 shadow-sm" />
                    <p class="text-xs text-gray-500 italic">Không được phép cập nhật khung giờ.</p>
                  </div>`;
              }
              return `
                <div>
                  <label class="block text-sm font-medium capitalize text-gray-600">${key}</label>
                  <input name="${key}" 
                         value="${sv[key] || ""}" 
                         ${sv[key] 
                            ? "readonly class='w-full border p-3 rounded-lg bg-gray-100 text-gray-500 shadow-sm'" 
                            : "class='w-full border p-3 rounded-lg bg-yellow-50 border-yellow-400 shadow-sm focus:ring focus:ring-yellow-300' placeholder='Nhập thông tin...' "}
                  />
                </div>`;
            }).join("")}
            <button type="submit" class="w-full bg-green-600 text-white px-5 py-3 rounded-xl hover:bg-green-700 font-semibold shadow">
              Lưu thông tin
            </button>
          </form>
        `;
      }

      container.innerHTML = infoHTML;
    }

    // Sự kiện tìm kiếm
    document.getElementById("searchForm").onsubmit = async (e) => {
      e.preventDefault();
      const mssv = document.getElementById("mssvInput").value.trim();
      if (!mssv) return alert("Vui lòng nhập MSSV!");

      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        const sv = data.find(x => x.mssv == mssv);
        currentSV = sv || null;
        renderInfo(currentSV);
      } catch (err) {
        console.error(err);
        alert("Lỗi khi gọi API!");
      }
    };

    // Xử lý submit updateForm
    document.addEventListener("submit", async (e) => {
      if (e.target && e.target.id === "updateForm") {
        e.preventDefault();
        const formData = new FormData(e.target);
        let updated = { ...currentSV };

        formData.forEach((val, key) => {
          // Nếu là khunggio và ban đầu rỗng => bỏ qua không cập nhật
          if (key === "khunggio" && !currentSV[key]) {
            updated[key] = ""; 
          } else {
            updated[key] = val;
          }
        });

        updated.trangthai = 1;

        try {
          const res = await fetch(`${API_URL}/${currentSV.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(updated)
          });

          if (res.ok) {
            alert("Cập nhật thành công!");
            currentSV = updated;
            renderInfo(updated);
          } else {
            alert("Cập nhật thất bại!");
          }
        } catch (err) {
          alert("Lỗi khi cập nhật!");
        }
      }
    });
  </script>
</body>
</html>
