<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Thống kê đăng ký Văn Nghệ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-7xl mx-auto bg-white shadow-lg rounded-xl p-6">
    <h1 class="text-3xl font-bold text-center text-indigo-600 mb-6">Thống kê Đăng ký Văn Nghệ</h1>

    <!-- Bộ lọc -->
    <div class="mb-4 flex flex-wrap justify-between items-center gap-3">
      <div class="flex items-center gap-2">
        <label class="font-semibold">Trạng thái:</label>
        <select id="filterStatus" class="border rounded p-2">
          <option value="">Tất cả</option>
          <option value="0">Chưa hoàn tất</option>
          <option value="1">Đã hoàn tất</option>
        </select>
      </div>

      <div class="flex items-center gap-2">
        <label class="font-semibold">Thể loại:</label>
        <select id="filterTheLoai" class="border rounded p-2">
          <option value="">Tất cả</option>
        </select>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnReload" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
          Tải lại
        </button>
        <button id="btnExport" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
          Xuất Excel
        </button>
      </div>
    </div>
    <!-- Bảng thống kê theo thể loại -->
    <h2 class="text-xl font-bold text-indigo-600 mb-2">Thống kê theo Thể loại</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full border-collapse text-sm">
        <thead>
          <tr class="bg-green-100 text-green-700">
            <th class="border px-3 py-2">Thể loại</th>
            <th class="border px-3 py-2">Số lượng</th>
          </tr>
        </thead>
        <tbody id="statsBody">
          <tr><td colspan="2" class="text-center py-4">Chưa có dữ liệu</td></tr>
        </tbody>
      </table>
    </div>
    <!-- Bảng chi tiết -->
    <div class="overflow-x-auto mb-6">
      <table class="min-w-full border-collapse text-sm">
        <thead>
          <tr class="bg-indigo-100 text-indigo-700">
            <th class="border px-3 py-2">ID</th>
            <th class="border px-3 py-2">Email</th>
            <th class="border px-3 py-2">MSSV</th>
            <th class="border px-3 py-2">Lớp</th>
            <th class="border px-3 py-2">SĐT</th>
            <th class="border px-3 py-2">Khoa</th>
            <th class="border px-3 py-2">Thể loại</th>
            <th class="border px-3 py-2">Họ tên</th>
            <th class="border px-3 py-2">Thời gian dự thi</th>
            <th class="border px-3 py-2">Khung giờ</th>
            <th class="border px-3 py-2">Tên tiết mục</th>
            <th class="border px-3 py-2">Thông tin bạn đồng hành</th>
            <th class="border px-3 py-2">Trạng thái</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="13" class="text-center py-4">Đang tải dữ liệu...</td></tr>
        </tbody>
      </table>
    </div>


  </div>

  <script>
    const API_URL = "https://68dd11d77cd1948060ac464f.mockapi.io/vannghe";
    let allData = [];

    async function fetchData() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error("Không lấy được dữ liệu");
        return await res.json();
      } catch (err) {
        console.error(err);
        return [];
      }
    }

    function renderTable(data) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="13" class="text-center py-4">Không có dữ liệu</td></tr>`;
        return;
      }

      data.forEach(item => {
        const statusText = item.trangthai == 1 ? "Đã hoàn tất" : "Chưa hoàn tất";
        const row = `
          <tr class="hover:bg-gray-50">
            <td class="border px-3 py-2">${item.id}</td>
            <td class="border px-3 py-2">${item.email || ""}</td>
            <td class="border px-3 py-2">${item.mssv || ""}</td>
            <td class="border px-3 py-2">${item.lop || ""}</td>
            <td class="border px-3 py-2">${item.sodienthoai || ""}</td>
            <td class="border px-3 py-2">${item.khoa || ""}</td>
            <td class="border px-3 py-2">${item.theloai || ""}</td>
            <td class="border px-3 py-2">${item.hoten || ""}</td>
            <td class="border px-3 py-2">${item.thoigianduthi || ""}</td>
            <td class="border px-3 py-2">${item.khunggio || ""}</td>
            <td class="border px-3 py-2">${item.tentietmuc || ""}</td>
            <td class="border px-3 py-2">${item.thongtinbandonghanh || "Không có"}</td>
            <td class="border px-3 py-2">${statusText}</td>
          </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    function renderStats(data) {
      const tbody = document.getElementById("statsBody");
      tbody.innerHTML = "";

      if (!data || data.length === 0) {
        tbody.innerHTML = `<tr><td colspan="2" class="text-center py-4">Không có dữ liệu</td></tr>`;
        return;
      }

      const counts = {};
      data.forEach(item => {
        const tl = item.theloai || "Khác";
        counts[tl] = (counts[tl] || 0) + 1;
      });

      Object.entries(counts).forEach(([theloai, count]) => {
        const row = `
          <tr>
            <td class="border px-3 py-2">${theloai}</td>
            <td class="border px-3 py-2 text-center">${count}</td>
          </tr>`;
        tbody.insertAdjacentHTML("beforeend", row);
      });
    }

    function filterData() {
      const filterStatus = document.getElementById("filterStatus").value;
      const filterTheLoai = document.getElementById("filterTheLoai").value;

      return allData.filter(item => {
        let match = true;
        if (filterStatus === "0" || filterStatus === "1") {
          match = match && String(item.trangthai) === filterStatus;
        }
        if (filterTheLoai) {
          match = match && item.theloai === filterTheLoai;
        }
        return match;
      });
    }

    async function loadAndRender() {
      allData = await fetchData();

      // Tạo danh sách thể loại cho combobox
      const uniqueTheLoai = [...new Set(allData.map(i => i.theloai).filter(Boolean))];
      const select = document.getElementById("filterTheLoai");
      select.innerHTML = `<option value="">Tất cả</option>`;
      uniqueTheLoai.forEach(tl => {
        select.insertAdjacentHTML("beforeend", `<option value="${tl}">${tl}</option>`);
      });

      const filtered = filterData();
      renderTable(filtered);
      renderStats(filtered);
    }

    document.getElementById("filterStatus").addEventListener("change", () => {
      const filtered = filterData();
      renderTable(filtered);
      renderStats(filtered);
    });
    document.getElementById("filterTheLoai").addEventListener("change", () => {
      const filtered = filterData();
      renderTable(filtered);
      renderStats(filtered);
    });
    document.getElementById("btnReload").addEventListener("click", loadAndRender);

    document.getElementById("btnExport").addEventListener("click", () => {
      const dataToExport = filterData().map(item => ({
        ID: item.id,
        Email: item.email || "",
        MSSV: item.mssv || "",
        Lop: item.lop || "",
        SDT: item.sodienthoai || "",
        Khoa: item.khoa || "",
        TheLoai: item.theloai || "",
        HoTen: item.hoten || "",
        ThoiGianDuThi: item.thoigianduthi || "",
        KhungGio: item.khunggio || "",
        TenTietMuc: item.tentietmuc || "",
        ThongTinBanDongHanh: item.thongtinbandonghanh || "",
        TrangThai: item.trangthai == 1 ? "Đã hoàn tất" : "Chưa hoàn tất"
      }));
      const ws = XLSX.utils.json_to_sheet(dataToExport);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "DanhSach");
      XLSX.writeFile(wb, "DanhSachVanNghe.xlsx");
    });

    loadAndRender();
  </script>
</body>
</html>
